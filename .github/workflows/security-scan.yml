name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ============================================================================
  # SECRET SCANNING: Detect leaked secrets
  # ============================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential secrets..."
          
          # Patterns to detect
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "api[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
            "aws[_-]?access[_-]?key"
            "aws[_-]?secret[_-]?key"
            "private[_-]?key"
            "-----BEGIN.*PRIVATE KEY-----"
          )
          
          FOUND_SECRETS=false
          for pattern in "${PATTERNS[@]}"; do
            if grep -r -iE "$pattern" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=.git --exclude="*.lock" . 2>/dev/null; then
              echo "⚠️  WARNING: Potential secret pattern detected: $pattern"
              FOUND_SECRETS=true
            fi
          done
          
          if [ "$FOUND_SECRETS" = true ]; then
            echo "❌ ERROR: Potential secrets detected. Review and remove hardcoded secrets."
            exit 1
          fi
          
          echo "✅ No hardcoded secrets detected"

  # ============================================================================
  # DEPENDENCY VULNERABILITY SCANNING
  # ============================================================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run npm audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate --production || {
            echo "❌ ERROR: Vulnerabilities found"
            npm audit --audit-level=moderate --production --json > audit-results.json
            exit 1
          }
          echo "✅ No moderate or higher vulnerabilities"

      - name: Check for outdated packages
        run: |
          echo "Checking for outdated packages..."
          npm outdated || true
          echo "✅ Outdated package check completed"

      - name: Verify lockfile integrity
        run: |
          if [ ! -f package-lock.json ]; then
            echo "❌ ERROR: package-lock.json is required"
            exit 1
          fi
          
          # Verify lockfile matches package.json (warn but don't fail)
          if ! npm ci --dry-run 2>&1 | grep -q "up to date\|added\|removed"; then
            echo "⚠️  WARNING: package-lock.json may be out of sync"
            echo "⚠️  Run 'npm install --package-lock-only' locally to fix"
          else
            echo "✅ Lockfile integrity verified"
          fi
        continue-on-error: true

  # ============================================================================
  # CODE SECURITY: SAST (Static Application Security Testing)
  # ============================================================================
  code-scan:
    name: Code Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run ESLint security rules
        run: |
          npx eslint . --ext .ts,.tsx --format json --output-file eslint-results.json || true
          echo "✅ ESLint security scan completed"

      - name: Check for dangerous patterns
        run: |
          echo "Scanning for dangerous code patterns..."
          
          # Dangerous patterns
          DANGEROUS_PATTERNS=(
            "eval\("
            "Function\("
            "setTimeout\(.*,.*\)"
            "setInterval\(.*,.*\)"
            "innerHTML\s*="
            "dangerouslySetInnerHTML"
            "document\.write"
            "localStorage\.setItem.*password"
            "sessionStorage\.setItem.*password"
          )
          
          FOUND_ISSUES=false
          for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if grep -r -iE "$pattern" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=.git app lib components 2>/dev/null; then
              echo "⚠️  WARNING: Potentially dangerous pattern detected: $pattern"
              FOUND_ISSUES=true
            fi
          done
          
          if [ "$FOUND_ISSUES" = true ]; then
            echo "⚠️  WARNING: Potentially dangerous patterns found. Review manually."
          else
            echo "✅ No dangerous patterns detected"
          fi

  # ============================================================================
  # LICENSE COMPLIANCE CHECK
  # ============================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Check licenses
        run: |
          echo "Checking package licenses..."
          npx license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC" --excludePrivatePackages || {
            echo "⚠️  WARNING: Some packages have non-approved licenses"
            echo "Review licenses manually"
          }
          echo "✅ License check completed"
        continue-on-error: true
