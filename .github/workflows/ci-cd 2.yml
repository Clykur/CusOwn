# CI/CD Pipeline – enterprise-grade security. See docs/BRANCH_AND_PR_WORKFLOW.md
# Production deploy: only on push to main; use GitHub Environment "production" with Required reviewers.

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'fix/**'
      - 'chore/**'
      - 'docs/**'
      - 'release/**'
  pull_request:
    branches: [main, develop]
  schedule:
    # Weekly security scan (no deploy). Secret scan + dependency audit.
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
        default: production

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions; jobs override when they need more (e.g. security-events: write).
permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: '22'
  NODE_OPTIONS: '--max-old-space-size=4096'
  CI: true
  # Audit level: high | critical. Override via repo variable NPM_AUDIT_LEVEL.
  NPM_AUDIT_LEVEL: ${{ vars.NPM_AUDIT_LEVEL || 'high' }}

jobs:
  # ---------------------------------------------------------------------------
  # Observability: audit trail (no secrets). Phase 10.
  # ---------------------------------------------------------------------------
  audit-trail:
    name: Audit trail
    runs-on: ubuntu-latest
    timeout-minutes: 2
    permissions:
      contents: read
    steps:
      - name: Log workflow context (no secrets)
        run: |
          echo "## Workflow audit" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | ${{ github.workflow }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Event | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # SECURITY: Gates for production. Deploy runs only if this job passes.
  # Fail on: secrets, high/critical vulns, disallowed licenses, dangerous patterns.
  # ---------------------------------------------------------------------------
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [audit-trail]
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
          persist-credentials: false

      # Fail pipeline on any confirmed secret – only safe code can deploy.
      - name: Gitleaks – Secret scanning
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Verify package-lock.json exists
        run: |
          if [ ! -f package-lock.json ]; then
            echo "ERROR: package-lock.json is missing. Lockfile is required for security."
            exit 1
          fi
          echo "package-lock.json verified"

      - name: Install dependencies (read-only)
        run: |
          npm ci --ignore-scripts --no-audit
          echo "Dependencies installed with scripts disabled"

      - name: Check for lockfile tampering
        run: |
          if ! npm ci --dry-run 2>&1 | grep -q "up to date\|added\|removed"; then
            echo "WARNING: package-lock.json may be out of sync with package.json"
            echo "Run 'npm install --package-lock-only' locally to fix"
          else
            echo "Lockfile integrity verified"
          fi
        continue-on-error: true

      # Phase 2: npm audit – fail on HIGH/CRITICAL. No silent ignore.
      - name: Run npm audit
        run: |
          set -e
          npm audit --audit-level=${{ env.NPM_AUDIT_LEVEL }} --omit=dev 2>&1 | tee audit.log || true
          if grep -qE "high severity|critical severity" audit.log 2>/dev/null; then
            echo "High or critical vulnerabilities found. Fix before merging."
            exit 1
          fi
          echo "No high/critical vulnerabilities"

      # Fail on disallowed licenses – only safe code can deploy.
      - name: License check
        run: |
          set -e
          ALLOWLIST_FILE=".github/license-allowlist.txt"
          if [ -n "$LICENSE_ALLOWLIST" ]; then
            ALLOWED=$(echo "$LICENSE_ALLOWLIST" | tr ',' '\n' | sed 's/^ *//;s/ *$//')
          elif [ -f "$ALLOWLIST_FILE" ]; then
            ALLOWED=$(grep -v '^#' "$ALLOWLIST_FILE" | grep -v '^$' | tr -d '\r')
          else
            ALLOWED="MIT
          Apache-2.0
          BSD-2-Clause
          BSD-3-Clause
          ISC"
          fi
          ALLOWED=$(echo "$ALLOWED" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | grep . || true)
          npx --yes license-checker --production --json 2>/dev/null > licenses.json || true
          if [ ! -s licenses.json ]; then
            echo "ERROR: Could not generate license report. Fix license-checker or allowlist."
            exit 1
          fi
          PROJECT_NAME=$(jq -r '.name // "cusown"' package.json)
          DISALLOWED=""
          while IFS= read -r pkg; do
            [ -z "$pkg" ] && continue
            # Skip the project's own package (e.g. cusown@0.1.0 with UNLICENSED)
            case "$pkg" in "$PROJECT_NAME"@*) continue ;; esac
            lic=$(jq -r ".\"$pkg\".licenses // \"UNKNOWN\"" licenses.json 2>/dev/null | tr -d '"' | head -1)
            [ -z "$lic" ] || [ "$lic" = "undefined" ] && lic="UNKNOWN"
            # Normalize: strip parens and * suffix; for "X OR Y" / "X AND Y" check each token
            lic_clean=$(echo "$lic" | tr -d '()' | sed 's/\*$//')
            allowed_match=false
            if echo "$lic_clean" | grep -qE ' (OR|AND) '; then
              if echo "$lic_clean" | grep -q ' OR '; then
                for token in $(echo "$lic_clean" | sed 's/ OR / /g'); do
                  token=$(echo "$token" | sed 's/^ *//;s/ *$//')
                  while IFS= read -r a; do
                    [ -z "$a" ] && continue
                    if [ "$token" = "$(echo "$a" | sed 's/\*$//')" ]; then allowed_match=true; break 2; fi
                  done <<< "$ALLOWED"
                done
              else
                all_ok=true
                for token in $(echo "$lic_clean" | sed 's/ AND / /g'); do
                  token=$(echo "$token" | sed 's/^ *//;s/ *$//')
                  tok_ok=false
                  while IFS= read -r a; do
                    [ -z "$a" ] && continue
                    if [ "$token" = "$(echo "$a" | sed 's/\*$//')" ]; then tok_ok=true; break; fi
                  done <<< "$ALLOWED"
                  if [ "$tok_ok" = false ]; then all_ok=false; break; fi
                done
                [ "$all_ok" = true ] && allowed_match=true
              fi
            else
              norm_lic=$(echo "$lic_clean" | cut -d' ' -f1)
              while IFS= read -r a; do
                [ -z "$a" ] && continue
                anorm=$(echo "$a" | sed 's/\*$//')
                if [ "$norm_lic" = "$anorm" ] || [ "$lic" = "$a" ]; then allowed_match=true; break; fi
              done <<< "$ALLOWED"
            fi
            if [ "$allowed_match" = false ]; then
              DISALLOWED="$DISALLOWED $pkg($lic)"
            fi
          done < <(jq -r 'keys[]' licenses.json 2>/dev/null)
          if [ -n "$DISALLOWED" ]; then
            echo "Disallowed or unknown licenses. Only safe code can deploy:$DISALLOWED"
            exit 1
          fi
          echo "License check passed"
        env:
          LICENSE_ALLOWLIST: ${{ vars.LICENSE_ALLOWLIST }}

      # Phase 3: Dangerous pattern scan (no PII in output). Fail on detection.
      - name: Dangerous code patterns
        run: |
          set -e
          FOUND=0
          for pattern in 'eval\(' 'Function\(' 'innerHTML\s*=' 'dangerouslySetInnerHTML' 'document\.write'; do
            if grep -r -iE "$pattern" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=.git app lib components 2>/dev/null; then
              echo "Dangerous pattern detected: $pattern"
              FOUND=1
            fi
          done
          if [ "$FOUND" -eq 1 ]; then
            echo "Fix or justify dangerous patterns before merging."
            exit 1
          fi
          echo "No dangerous patterns detected"

  # ---------------------------------------------------------------------------
  # Lint & Type Check
  # ---------------------------------------------------------------------------
  lint-and-test:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [audit-trail]
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run ESLint
        run: |
          npm run lint || { echo "Linting failed"; exit 1; }
          echo "Linting passed"

      - name: Type check
        run: |
          npm run typecheck || { echo "Type checking failed"; exit 1; }
          echo "Type checking passed"

  # ---------------------------------------------------------------------------
  # Build verification
  # ---------------------------------------------------------------------------
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint-and-test, security-scan]
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Verify required environment variables
        run: |
          MISSING_VARS=""
          for var in NEXT_PUBLIC_SUPABASE_URL NEXT_PUBLIC_SUPABASE_ANON_KEY SUPABASE_SERVICE_ROLE_KEY; do
            eval "val=\$$var"
            if [ -z "$val" ]; then MISSING_VARS="$MISSING_VARS $var"; fi
          done
          if [ -n "$MISSING_VARS" ]; then
            echo "Some env vars missing (set in Vercel for deploy):$MISSING_VARS"
          fi
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        continue-on-error: true

      - name: Build application
        run: |
          npm run build || { echo "Build failed"; exit 1; }
          echo "Build successful"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-anon-key' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'placeholder-service-role-key' }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://cusown.clykur.com' }}

      # Secret detection: Gitleaks runs on the repo in security-scan; .next is not scanned here
      # because bundled output (server chunks, cache, types, route paths) always contains
      # identifiers like key/token/secret, causing only false positives.

  # ---------------------------------------------------------------------------
  # SBOM generation. Phase 6. Main and release only; artifact only (no sensitive env in logs).
  # ---------------------------------------------------------------------------
  sbom:
    name: SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [audit-trail]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Generate SBOM (CycloneDX)
        run: npx --yes @cyclonedx/cyclonedx-npm --output-file sbom.json
        env:
          NODE_ENV: production

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: sbom-${{ github.run_number }}
          path: sbom.json
          retention-days: 90

  # ---------------------------------------------------------------------------
  # Production deploy: only safe code. Requires security-scan + lint-and-test + build to pass.
  # Only on push to main (not PR/schedule). Use Environment "production" + Required reviewers.
  # ---------------------------------------------------------------------------
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint-and-test, build] # build depends on security-scan – no deploy if security fails
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name != 'pull_request' &&
      github.event_name != 'schedule'
    environment:
      name: production
      url: https://cusown.clykur.com
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Check Vercel secrets
        id: vercel-check
        run: |
          if [ -z "$VERCEL_TOKEN" ] || [ -z "$VERCEL_ORG_ID" ] || [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "skip_deploy=true" >> $GITHUB_OUTPUT
            echo "Vercel secrets missing; deploy will be SKIPPED."
          else
            echo "skip_deploy=false" >> $GITHUB_OUTPUT
            echo "Vercel secrets present; deploy will run."
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Verify production deployment conditions
        run: |
          echo "Production deployment conditions checked (main only, not PR/schedule)."

      - name: Deploy to Vercel (Production)
        if: steps.vercel-check.outputs.skip_deploy != 'true'
        uses: amondnet/vercel-action@16e87c0a08142b0d0d33b76aeaf20823c381b9b9
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod --force'
          scope: ${{ secrets.VERCEL_ORG_ID }}
          github-comment: true
          github-deployment: true

      - name: Production deployment verification
        if: steps.vercel-check.outputs.skip_deploy != 'true'
        run: |
          echo "Production deployment completed. Monitor application health."

      - name: Deploy skipped (no Vercel secrets)
        if: steps.vercel-check.outputs.skip_deploy == 'true'
        run: |
          echo "## Deployment was SKIPPED" >> $GITHUB_STEP_SUMMARY
          echo "Vercel secrets are not configured." >> $GITHUB_STEP_SUMMARY
          echo "Add VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID in Settings → Secrets and variables → Actions." >> $GITHUB_STEP_SUMMARY

      - name: Deployment audit log
        run: |
          echo "## Production Deployment Audit" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
