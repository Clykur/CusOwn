name: CI/CD Pipeline

# Supports both: (1) direct push to main, (2) PR workflow. See docs/BRANCH_AND_PR_WORKFLOW.md
on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'fix/**'
      - 'chore/**'
      - 'docs/**'
      - 'release/**'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
        default: production

# Prevent concurrent runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18.x'
  NODE_OPTIONS: '--max-old-space-size=4096'
  CI: true

# Use default GitHub-hosted runners (ubuntu-latest); no custom runner labels
jobs:
  # ============================================================================
  # SECURITY: Secret Scanning, Dependency & Supply Chain Checks
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Gitleaks - Secret Scanning
        uses: gitleaks/gitleaks-action@v2.3.9
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Verify package-lock.json exists
        run: |
          if [ ! -f package-lock.json ]; then
            echo "❌ ERROR: package-lock.json is missing. Lockfile is required for security."
            exit 1
          fi
          echo "✅ package-lock.json verified"

      - name: Install dependencies (read-only)
        run: |
          npm ci --ignore-scripts --no-audit
          echo "✅ Dependencies installed with scripts disabled"

      - name: Check for lockfile tampering
        run: |
          if ! npm ci --dry-run 2>&1 | grep -q "up to date\|added\|removed"; then
            echo "⚠️  WARNING: package-lock.json may be out of sync with package.json"
            echo "⚠️  Run 'npm install --package-lock-only' locally to fix"
          else
            echo "✅ Lockfile integrity verified"
          fi
        continue-on-error: true

      - name: Run npm audit (fail on high/critical)
        id: npm-audit
        continue-on-error: true
        run: |
          npm audit --audit-level=high --omit=dev 2>&1 | tee audit.log || true
          if grep -q "high severity\|critical severity" audit.log 2>/dev/null; then
            echo "⚠️  High/critical vulnerabilities found (see audit.log). Upgrade Next.js to 15.5.12+ when ready to fix."
            echo "audit_failed=true" >> $GITHUB_OUTPUT
          else
            echo "✅ No high/critical vulnerabilities"
            echo "audit_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for dangerous code patterns
        run: |
          echo "Scanning for dangerous code patterns..."
          DANGEROUS_PATTERNS=(
            "eval\("
            "Function\("
            "innerHTML\s*="
            "dangerouslySetInnerHTML"
            "document\.write"
          )
          FOUND_ISSUES=false
          for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if grep -r -iE "$pattern" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=.git app lib components 2>/dev/null; then
              echo "⚠️  WARNING: Potentially dangerous pattern detected: $pattern"
              FOUND_ISSUES=true
            fi
          done
          if [ "$FOUND_ISSUES" = true ]; then
            echo "⚠️  WARNING: Potentially dangerous patterns found. Review manually."
          else
            echo "✅ No dangerous patterns detected"
          fi
        continue-on-error: true

  # ============================================================================
  # CODE QUALITY: Linting, Type Checking
  # ============================================================================
  lint-and-test:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run ESLint
        run: |
          npm run lint || {
            echo "❌ ERROR: Linting failed"
            exit 1
          }
          echo "✅ Linting passed"

      - name: Type check
        run: |
          npm run typecheck || {
            echo "❌ ERROR: Type checking failed"
            exit 1
          }
          echo "✅ Type checking passed"

  # ============================================================================
  # BUILD: Production Build Verification
  # ============================================================================
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint-and-test]
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Verify required environment variables
        run: |
          echo "Checking required environment variables..."
          MISSING_VARS=""
          REQUIRED_VARS=(
            "NEXT_PUBLIC_SUPABASE_URL"
            "NEXT_PUBLIC_SUPABASE_ANON_KEY"
            "SUPABASE_SERVICE_ROLE_KEY"
          )
          for var in "${REQUIRED_VARS[@]}"; do
            var_value="${!var}"
            if [ -z "$var_value" ]; then
              MISSING_VARS="${MISSING_VARS} ${var}"
              echo "⚠️  Missing: $var"
            else
              echo "✅ Found: $var"
            fi
          done
          if [ -n "$MISSING_VARS" ]; then
            echo "⚠️  WARNING: Some environment variables are missing:$MISSING_VARS"
            echo "⚠️  Build may fail if these are required. Set them in GitHub Secrets if needed."
            echo "ℹ️  For now, continuing with build (variables should be set in Vercel for deployment)"
          else
            echo "✅ All required environment variables present"
          fi
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        continue-on-error: true

      - name: Build application
        run: |
          echo "Building application..."
          npm run build || {
            echo "❌ ERROR: Build failed"
            echo "ℹ️  Set NEXT_PUBLIC_SUPABASE_*, SUPABASE_SERVICE_ROLE_KEY in repo Secrets if needed."
            exit 1
          }
          echo "✅ Build successful"
        env:
          # Use secrets when set; otherwise placeholders so build can complete (real values in Vercel)
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-anon-key' }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'placeholder-service-role-key' }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://cusown.clykur.com' }}

      - name: Check for secrets in build output
        run: |
          if grep -r -iE "(password|secret|key|token|api[_-]?key)" .next 2>/dev/null | grep -v "node_modules" | head -10; then
            echo "⚠️  WARNING: Potential secrets detected in build output (review manually)"
          else
            echo "✅ No obvious secrets in build output"
          fi
        continue-on-error: true

  # ============================================================================
  # DEPLOYMENT: Production (after lint-and-test + build succeed)
  # Only on push to main (not on pull_request). See docs/BRANCH_AND_PR_WORKFLOW.md
  # Skipped if Vercel secrets are missing. Add in repo: Settings → Secrets → Actions:
  #   VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID (from Vercel dashboard / .vercel)
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [lint-and-test, build]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name != 'pull_request'
    environment:
      name: production
      url: https://cusown.clykur.com
    permissions:
      contents: read
      deployments: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Check Vercel secrets
        id: vercel-check
        run: |
          if [ -z "$VERCEL_TOKEN" ] || [ -z "$VERCEL_ORG_ID" ] || [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "skip_deploy=true" >> $GITHUB_OUTPUT
            echo "⚠️  Vercel secrets missing; deploy will be SKIPPED."
            echo "Add VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID in repo: Settings → Secrets and variables → Actions"
          else
            echo "skip_deploy=false" >> $GITHUB_OUTPUT
            echo "✅ Vercel secrets present; deploy will run."
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Verify production deployment conditions
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "⚠️  WARNING: Production deployment from non-main branch"
            echo "⚠️  For production safety, deploy only from main branch"
          fi
          if [ "${{ needs.lint-and-test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "⚠️  WARNING: Some prerequisite checks did not pass"
            echo "⚠️  For production safety, all checks should pass"
          fi
          echo "✅ Production deployment conditions checked"
        continue-on-error: true

      - name: Deploy to Vercel (Production)
        if: steps.vercel-check.outputs.skip_deploy != 'true'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod --force'
          scope: ${{ secrets.VERCEL_ORG_ID }}
          github-comment: true
          github-deployment: true

      - name: Production deployment verification
        if: steps.vercel-check.outputs.skip_deploy != 'true'
        run: |
          echo "✅ Production deployment completed"
          echo "Production URL: https://cusown.clykur.com"
          echo "⚠️  IMPORTANT: Monitor application health after deployment"

      - name: Deploy skipped (no Vercel secrets)
        if: steps.vercel-check.outputs.skip_deploy == 'true'
        run: |
          echo "## ⚠️ Deployment was SKIPPED" >> $GITHUB_STEP_SUMMARY
          echo "Vercel secrets are not configured. Code was not deployed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To enable deployment, add these in **Settings → Secrets and variables → Actions**:" >> $GITHUB_STEP_SUMMARY
          echo "- \`VERCEL_TOKEN\` (from Vercel: Account Settings → Tokens)" >> $GITHUB_STEP_SUMMARY
          echo "- \`VERCEL_ORG_ID\` and \`VERCEL_PROJECT_ID\` (from Vercel project settings or \`.vercel/project.json\`)" >> $GITHUB_STEP_SUMMARY

      - name: Create deployment audit log
        run: |
          echo "## Production Deployment Audit" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
